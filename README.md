# 概要

数百～数千枚の画像をできるだけ早くDBへアップし保存するCLI


# 取り組み

1. 処理速度の向上

    - Goroutineによる並行処理
        - ネックとなる画像データのI/O（データ読込／アップロード）待ちに、他データの処理を充てることができるため採用

    - NoSQL(MongoDB)を使用
        - アップロード時のスキーマ検証がないため採用（処理速度向上・負荷軽減が目的）

    - フィールドにインデックスを設定
        - 画像データのユニークチェック高速化を目的に設定

    - 事前コンパイル
        - 処理速度向上を目的に設定
---

2. 負荷軽減・安定稼働

    - DBへの接続リトライ
        - 一時的な接続失敗でアプリが停止するのを防止
---

3. その他

    - 拡張子偽造対策
        - ヘッダー情報をもとにMIMEタイプを正確に判定


# 実行結果

アップロード件数：1398 件
<div align="center">

|                               | MongoDB | MySQL |
| :---                          | :---: | :---: |
| アップロードにかかった時間(ms)  | 712.022985 | |
| 平均処理速度(files/s)          | 1963.42    | |

</div>


# アップロード手順

1. `images/upload` 下にアップしたい画像を配置

2. アップロードコマンド
    ```bash
    docker-compose up --build
    ```

3. 完了したら
    ```bash
    docker-compose down

    # DB内データも削除する場合はこちら
    docker-compose down -v
    ```


# 備忘録

## ライブラリのインストール
```bash
docker run --rm -v ${PWD}/app:/usr/src/app -w /usr/src/app golang:1.21 sh -c "go mod tidy"
```
